# Sieve Script Reference

This document explains how ProtonFusion generates Sieve scripts and how they interact with ProtonMail.

## What is Sieve?

Sieve is a standardized email filtering language defined in [RFC 5228](https://www.rfc-editor.org/rfc/rfc5228). ProtonMail supports Sieve for server-side mail filtering, in addition to its UI-based filter wizard. Sieve scripts run on ProtonMail's servers and process incoming mail before it reaches your inbox.

## Generated Script Structure

A typical ProtonFusion-generated Sieve script looks like:

```sieve
require ["fileinto", "imap4flags"];

# === BEGIN ProtonFusion ===
# ProtonFusion - Filter Consolidation
# Generated by ProtonFusion v0.1.0
# Total rules: 3

# Delete spam (consolidated from 25 filters)
# Source filters: Block spammer1, Block spammer2, Block spammer3
#   ... and 22 more
if address :is "From" ["spammer1@example.com", "spammer2@example.com", "spammer3@example.com"] {
    discard;
}

# Move to Work (consolidated from 10 filters)
if address :is "From" ["alice@company.com", "bob@company.com", "charlie@company.com"] {
    fileinto "Work";
}

# Mark newsletter as read
if header :contains "Subject" "newsletter" {
    addflag "\\Seen";
}
# === END ProtonFusion ===
```

## Extensions

Sieve extensions are declared via `require` statements at the top of the script. ProtonFusion automatically collects the required extensions:

| Extension | Triggered By |
|-----------|-------------|
| `fileinto` | move_to, label, or archive actions |
| `imap4flags` | mark_read or star actions |
| `regex` | conditions using the "matches" operator |

## Condition Mapping

| ProtonMail UI | Sieve Test |
|---------------|-----------|
| Sender is "X" | `address :is "From" "X"` |
| Sender contains "X" | `address :contains "From" "X"` |
| Recipient is "X" | `address :is "To" "X"` |
| Subject contains "X" | `header :contains "Subject" "X"` |
| Subject matches "X*" | `header :matches "Subject" "X*"` |

### Array Values

When multiple filters with the same condition type and operator are consolidated, their values become a Sieve array:

```sieve
# Before consolidation: 3 separate rules
if address :is "From" "alice@example.com" { fileinto "Work"; }
if address :is "From" "bob@example.com" { fileinto "Work"; }
if address :is "From" "charlie@example.com" { fileinto "Work"; }

# After consolidation: 1 rule with array
if address :is "From" ["alice@example.com", "bob@example.com", "charlie@example.com"] {
    fileinto "Work";
}
```

### Condition Logic

Within a single original filter, conditions may be AND'd or OR'd:

```sieve
# AND: all conditions must match
if allof (
    address :is "From" "alice@example.com",
    header :contains "Subject" "urgent"
) {
    fileinto "Priority";
}

# OR: any condition matching is sufficient
if anyof (
    address :is "From" "alice@example.com",
    address :is "From" "bob@example.com"
) {
    fileinto "Work";
}
```

When multiple filters are consolidated, their condition groups are OR'd together using `anyof`.

## Action Mapping

| ProtonMail UI | Sieve Action |
|---------------|-------------|
| Move to folder | `fileinto "FolderName";` |
| Apply label | `fileinto "LabelName";` |
| Mark as read | `addflag "\\Seen";` |
| Star message | `addflag "\\Flagged";` |
| Move to Archive | `fileinto "Archive";` |
| Move to Trash / Delete | `discard;` |

### Folder Paths

ProtonMail supports nested folders. In the Sieve script, nested folders use a path separator:

```sieve
fileinto "Parent/Child";
```

ProtonFusion automatically resolves the display names from ProtonMail's dropdown (which prefixes subfolders with a bullet character) to full folder paths.

## Section Markers

ProtonFusion wraps its generated rules in section markers:

```sieve
# === BEGIN ProtonFusion ===
... generated rules ...
# === END ProtonFusion ===
```

This allows ProtonFusion to coexist with hand-written Sieve rules. When you re-run consolidation and sync:

1. Everything between the markers is replaced with the new rules
2. Everything outside the markers is preserved
3. `require` statements from both sections are merged and deduplicated

### Example: Coexistence with User Rules

```sieve
require ["fileinto", "imap4flags", "vacation"];

# === BEGIN ProtonFusion ===
# ... ProtonFusion-generated rules ...
# === END ProtonFusion ===

# My custom vacation responder
if true {
    vacation "I'm out of office until Monday.";
}
```

## Rule Ordering

ProtonFusion orders rules by action priority:

1. **Delete/discard** -- highest priority (stops processing, removes spam first)
2. **Archive** -- next most impactful
3. **Move to folder** -- routing
4. **Label** -- categorization
5. **Mark as read** -- cosmetic
6. **Star** -- cosmetic

Within the same action type, rules that consolidate more original filters are placed first.

## ProtonMail-Specific Notes

- ProtonMail treats labels as folders internally; both use `fileinto`.
- The `\\Seen` and `\\Flagged` IMAP flags require the `imap4flags` extension.
- ProtonMail's free tier limits you to 1 custom filter. ProtonFusion's sync workflow disables existing UI filters before uploading the Sieve filter, freeing the slot.
- ProtonMail's Sieve editor uses CodeMirror 5. The upload process uses the JavaScript API (`setValue()`) to properly trigger change detection.
