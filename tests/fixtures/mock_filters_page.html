<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mock ProtonMail Filters Page</title>
<style>
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; }
  .modal-overlay.visible { display: flex; align-items: center; justify-content: center; }
  .modal-content { background: white; padding: 20px; border-radius: 8px; min-width: 500px; }
  .hidden { display: none; }
  table.simple-table { width: 100%; border-collapse: collapse; }
  table.simple-table td { padding: 8px; }
  .toggle-label input { appearance: auto; }
  .condition-token [title] { display: inline-block; padding: 2px 6px; background: #eee; border-radius: 4px; margin: 2px; }
  li.dropdown-item { list-style: none; padding: 4px 8px; cursor: pointer; }
  button.select { padding: 4px 8px; border: 1px solid #ccc; background: white; cursor: pointer; }
</style>
</head>
<body>

<!-- Page heading (selectors.PAGE_HEADING = '.container-section-sticky h1') -->
<div class="container-section-sticky">
  <h1>Filters</h1>
</div>

<!-- Button area -->
<button id="addFilterBtn">Add filter</button>

<!-- Section 1: Custom filters (selectors.CUSTOM_FILTERS_SECTION) -->
<section>
  <h2>Custom filters</h2>
  <table class="simple-table">
    <tbody id="filterTableBody">
      <!-- Filters will be generated by JS -->
    </tbody>
  </table>
</section>

<!-- Section 2: Spam, block, and allow lists -->
<section>
  <h2>Spam, block, and allow lists</h2>
  <p>Spam list entries here (should NOT be scraped)</p>
</section>

<!-- Modal overlay for filter wizard.
     Uses a SINGLE Next button and SINGLE Close button, always visible.
     The scraper uses page.query_selector which returns the first DOM match,
     so we must not have duplicate data-testid elements with varying visibility. -->
<div class="modal-overlay" id="filterModal">
  <div class="modal-content">
    <button data-testid="modal:close" id="modalCloseBtn" onclick="closeModal()">Close</button>

    <!-- Step 1: Name -->
    <div id="step-name" class="wizard-step">
      <h3>Filter name</h3>
      <input data-testid="filter-modal:name-input" id="modalFilterName" type="text" readonly>
    </div>

    <!-- Step 2: Conditions -->
    <div id="step-conditions" class="wizard-step hidden">
      <h3>Conditions</h3>
      <div id="conditionsContainer"></div>
      <div id="logicRadios">
        <label><input type="radio" name="logic" value="all" checked> ALL of the following</label>
        <label><input type="radio" name="logic" value="any"> ANY of the following</label>
      </div>
    </div>

    <!-- Step 3: Actions -->
    <div id="step-actions" class="wizard-step hidden">
      <h3>Actions</h3>
      <div id="actionsContainer"></div>
    </div>

    <!-- Single Next/Cancel buttons always visible at bottom of modal -->
    <div id="modalButtons">
      <button data-testid="filter-modal:next-button" id="nextBtn" onclick="advanceStep()">Next</button>
      <button id="cancelBtn" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Dropdown for folder selection (hidden, shown on click) -->
<ul id="folderDropdown" class="hidden" style="position:absolute; background:white; border:1px solid #ccc; z-index:200;">
  <li class="dropdown-item">Do not move</li>
  <li class="dropdown-item">Inbox - Default</li>
  <li class="dropdown-item">Work</li>
  <li class="dropdown-item">• Projects</li>
  <li class="dropdown-item">• Reports</li>
  <li class="dropdown-item">Personal</li>
  <li class="dropdown-item">• Finance</li>
  <li class="dropdown-item">Archive</li>
  <li class="dropdown-item">Trash</li>
</ul>

<script>
// Filter data - 10 mock filters with varying conditions/actions
const FILTERS = [
  {
    name: "Newsletter Trash",
    enabled: true,
    logic: "all",
    conditions: [
      { type: "the sender", operator: "contains", values: ["newsletter@example.com"] }
    ],
    folder: "Trash",
    markRead: false,
    markStarred: false
  },
  {
    name: "Work Emails",
    enabled: true,
    logic: "all",
    conditions: [
      { type: "the sender", operator: "ends with", values: ["@company.com"] }
    ],
    folder: "Work",
    markRead: false,
    markStarred: false
  },
  {
    name: "Project Updates",
    enabled: true,
    logic: "all",
    conditions: [
      { type: "the subject", operator: "contains", values: ["project update"] }
    ],
    folder: "• Projects",
    markRead: true,
    markStarred: false
  },
  {
    name: "VIP Senders",
    enabled: true,
    logic: "any",
    conditions: [
      { type: "the sender", operator: "is exactly", values: ["boss@company.com"] },
      { type: "the sender", operator: "is exactly", values: ["ceo@company.com"] }
    ],
    folder: "Do not move",
    markRead: false,
    markStarred: true
  },
  {
    name: "Spam Filter",
    enabled: false,
    logic: "all",
    conditions: [
      { type: "the subject", operator: "contains", values: ["buy now", "limited offer"] }
    ],
    folder: "Trash",
    markRead: false,
    markStarred: false
  },
  {
    name: "Finance Reports",
    enabled: true,
    logic: "all",
    conditions: [
      { type: "the sender", operator: "contains", values: ["finance@company.com"] },
      { type: "the subject", operator: "begins with", values: ["Q"] }
    ],
    folder: "• Finance",
    markRead: false,
    markStarred: true
  },
  {
    name: "Read Receipts",
    enabled: true,
    logic: "all",
    conditions: [
      { type: "the subject", operator: "begins with", values: ["Read:"] }
    ],
    folder: "Archive",
    markRead: true,
    markStarred: false
  },
  {
    name: "Personal Mail",
    enabled: true,
    logic: "any",
    conditions: [
      { type: "the sender", operator: "ends with", values: ["@family.com"] },
      { type: "the sender", operator: "ends with", values: ["@friends.com"] }
    ],
    folder: "Personal",
    markRead: false,
    markStarred: false
  },
  {
    name: "Disabled Old Filter",
    enabled: false,
    logic: "all",
    conditions: [
      { type: "the recipient", operator: "is exactly", values: ["old@example.com"] }
    ],
    folder: "Do not move",
    markRead: false,
    markStarred: false
  },
  {
    name: "Multi-tag Filter",
    enabled: true,
    logic: "all",
    conditions: [
      { type: "the sender", operator: "contains", values: ["alert1@test.com", "alert2@test.com"] }
    ],
    folder: "Work",
    markRead: true,
    markStarred: true
  }
];

let currentFilter = null;
let currentStep = 'name';
const STEP_ORDER = ['name', 'conditions', 'actions'];

function buildFilterTable() {
  const tbody = document.getElementById('filterTableBody');
  FILTERS.forEach((f, idx) => {
    const tr = document.createElement('tr');
    // Toggle cell
    const tdToggle = document.createElement('td');
    const toggleLabel = document.createElement('label');
    toggleLabel.className = 'toggle-label';
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = f.enabled;
    toggleLabel.appendChild(checkbox);
    tdToggle.appendChild(toggleLabel);
    tr.appendChild(tdToggle);

    // Name cell
    const tdName = document.createElement('td');
    tdName.textContent = f.name;
    tr.appendChild(tdName);

    // Edit button cell
    const tdEdit = document.createElement('td');
    const editBtn = document.createElement('button');
    editBtn.setAttribute('aria-label', `Edit filter "${f.name}"`);
    editBtn.textContent = 'Edit';
    editBtn.onclick = function() { openModal(idx); };
    tdEdit.appendChild(editBtn);
    tr.appendChild(tdEdit);

    tbody.appendChild(tr);
  });
}

function openModal(idx) {
  currentFilter = FILTERS[idx];
  document.getElementById('modalFilterName').value = currentFilter.name;

  // Reset to name step
  currentStep = 'name';
  showStep('name');
  document.getElementById('filterModal').classList.add('visible');

  // Set logic radio
  const radios = document.querySelectorAll('input[name="logic"]');
  radios.forEach(r => {
    r.checked = (r.value === currentFilter.logic);
  });
}

function advanceStep() {
  const idx = STEP_ORDER.indexOf(currentStep);
  if (idx < STEP_ORDER.length - 1) {
    currentStep = STEP_ORDER[idx + 1];
    showStep(currentStep);
  }
}

function showStep(step) {
  document.querySelectorAll('.wizard-step').forEach(s => s.classList.add('hidden'));
  document.getElementById('step-' + step).classList.remove('hidden');

  if (step === 'conditions') {
    buildConditions();
  } else if (step === 'actions') {
    buildActions();
  }
}

function buildConditions() {
  const container = document.getElementById('conditionsContainer');
  container.innerHTML = '';
  if (!currentFilter) return;

  currentFilter.conditions.forEach((cond, ci) => {
    const row = document.createElement('div');
    row.setAttribute('data-testid', `filter-modal:condition-${ci}`);

    // Type select button
    const typeBtn = document.createElement('button');
    typeBtn.className = 'select';
    typeBtn.setAttribute('aria-label', cond.type);
    typeBtn.textContent = cond.type;
    row.appendChild(typeBtn);

    // Operator select button
    const opBtn = document.createElement('button');
    opBtn.className = 'select';
    opBtn.setAttribute('aria-label', cond.operator);
    opBtn.textContent = cond.operator;
    row.appendChild(opBtn);

    // Value tags (condition-token with [title])
    const tokenContainer = document.createElement('div');
    tokenContainer.className = 'condition-token';
    cond.values.forEach(v => {
      const tag = document.createElement('span');
      tag.setAttribute('title', v);
      tag.textContent = v;
      tokenContainer.appendChild(tag);
    });
    row.appendChild(tokenContainer);

    container.appendChild(row);
  });
}

function buildActions() {
  const container = document.getElementById('actionsContainer');
  container.innerHTML = '';
  if (!currentFilter) return;

  // Folder row
  const folderRow = document.createElement('div');
  folderRow.setAttribute('data-testid', 'filter-modal:folder-row');
  const folderBtn = document.createElement('button');
  folderBtn.className = 'select';
  folderBtn.setAttribute('aria-label', currentFilter.folder);
  folderBtn.textContent = currentFilter.folder;
  folderBtn.onclick = function(e) {
    e.stopPropagation();
    const dd = document.getElementById('folderDropdown');
    dd.classList.toggle('hidden');
    dd.style.top = (folderBtn.getBoundingClientRect().bottom + window.scrollY) + 'px';
    dd.style.left = folderBtn.getBoundingClientRect().left + 'px';
  };
  folderRow.appendChild(folderBtn);
  container.appendChild(folderRow);

  // Mark-as row
  const markRow = document.createElement('div');
  markRow.setAttribute('data-testid', 'filter-modal:mark-as-row');

  const readLabel = document.createElement('label');
  readLabel.textContent = 'Read';
  const readCb = document.createElement('input');
  readCb.type = 'checkbox';
  readCb.checked = currentFilter.markRead;
  readLabel.prepend(readCb);
  markRow.appendChild(readLabel);

  const starLabel = document.createElement('label');
  starLabel.textContent = 'Starred';
  const starCb = document.createElement('input');
  starCb.type = 'checkbox';
  starCb.checked = currentFilter.markStarred;
  starLabel.prepend(starCb);
  markRow.appendChild(starLabel);

  container.appendChild(markRow);
}

function closeModal() {
  document.getElementById('filterModal').classList.remove('visible');
  currentFilter = null;
  currentStep = 'name';
  // Hide folder dropdown too
  document.getElementById('folderDropdown').classList.add('hidden');
}

// Close dropdown on Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.getElementById('folderDropdown').classList.add('hidden');
  }
});

// Build the table on load
buildFilterTable();
</script>
</body>
</html>
